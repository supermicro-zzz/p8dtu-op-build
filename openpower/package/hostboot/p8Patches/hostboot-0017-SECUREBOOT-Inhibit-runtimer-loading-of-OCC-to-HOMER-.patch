From 14a09d36e1bc4754e79e8221b9ab4cab2149cdc6 Mon Sep 17 00:00:00 2001
From: Nick Bofferding <bofferdn@us.ibm.com>
Date: Wed, 9 Nov 2016 16:50:24 -0600
Subject: [PATCH] SECUREBOOT: Inhibit runtimer loading of OCC to HOMER w/
 secureboot enabled

Change-Id: Id702323b3ef00f657c39e818d85ac0be4349479b
---
 src/usr/hwpf/hwp/occ/occ_common.C | 31 ++++++++++++++++++++++++++-----
 1 file changed, 26 insertions(+), 5 deletions(-)

diff --git a/src/usr/hwpf/hwp/occ/occ_common.C b/src/usr/hwpf/hwp/occ/occ_common.C
index c5f43bc..5fee212 100644
--- a/src/usr/hwpf/hwp/occ/occ_common.C
+++ b/src/usr/hwpf/hwp/occ/occ_common.C
@@ -24,6 +24,7 @@
 /* IBM_PROLOG_END_TAG                                                     */
 
 #include    <stdint.h>
+#include    <config.h>
 
 #include    <occ/occ_common.H>
 #include    <occ/occAccess.H>
@@ -67,6 +68,10 @@
   #include <diag/prdf/prdfWriteHomerFirData.H>
 #endif
 
+#ifdef CONFIG_SECUREBOOT
+#include <secureboot/service.H>
+#endif
+
 // Easy macro replace for unit testing
 //#define TRACUCOMP(args...)  TRACFCOMP(args)
 #define TRACUCOMP(args...)
@@ -655,13 +660,29 @@ namespace HBOCC
                 break;
             }
 #endif
-            void* occVirt = reinterpret_cast<void *>(i_occImgVaddr);
-            l_errl = loadOCCImageToHomer( occVirt );
-            if( l_errl )
+
+            bool writeHomer = true;
+            #ifdef CONFIG_SECUREBOOT
+            #ifdef __HOSTBOOT_RUNTIME
+            if(SECUREBOOT::enabled())
             {
                 TRACFCOMP(g_fapiImpTd,
-                        ERR_MRK"loadOCC: loadOCCImageToHomer failed!");
-                break;
+                    INFO_MRK "loadOCC: Runtime request and secureboot "
+                    "enabled; not loading new OCC image to HOMER");
+                writeHomer = false;
+            }
+            #endif
+            #endif
+            if(writeHomer)
+            {
+                void* occVirt = reinterpret_cast<void *>(i_occImgVaddr);
+                l_errl = loadOCCImageToHomer( occVirt );
+                if( l_errl )
+                {
+                    TRACFCOMP(g_fapiImpTd,
+                            ERR_MRK"loadOCC: loadOCCImageToHomer failed!");
+                    break;
+                }
             }
           }
         }while(0);
-- 
1.8.2.2

